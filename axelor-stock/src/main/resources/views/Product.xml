<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<object-views xmlns="http://axelor.com/xml/ns/object-views"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://axelor.com/xml/ns/object-views http://axelor.com/xml/ns/object-views/object-views_7.0.xsd">

  <action-record name="action-product-set-stock"
    model="com.axelor.apps.base.db.Product" if-module="axelor-stock">
    <field name="$realQtyBtn"
      expr="call:com.axelor.apps.stock.service.StockLocationService:getRealQtyOfProductInStockLocations(id, null,null)"
      if="__config__.app.isApp('stock')"/>
    <field name="$futureQtyBtn"
      expr="call:com.axelor.apps.stock.service.StockLocationService:getFutureQtyOfProductInStockLocations(id, null,null)"
      if="__config__.app.isApp('stock')"/>
    <field name="$reservedQtyBtn"
      expr="call:com.axelor.apps.supplychain.service.StockLocationServiceSupplychain:getReservedQtyOfProductInStockLocations(id, null,null)"
      if="__config__.app.isApp('supplychain')"/>
  </action-record>

  <action-record name="action-product-record-service-stock-managed"
    model="com.axelor.apps.base.db.Product">
    <field name="stockManaged" expr="eval: productTypeSelect != 'service'"/>
  </action-record>

  <action-attrs name="action-product-attrs-scale-and-precision-stock"
    if-module="axelor-stock">
    <attribute name="scale" for="avgPrice"
      expr="eval: __config__.app.getNbDecimalDigitForUnitPrice()"/>
  </action-attrs>

  <cards name="stock-product-cards" title="Product" css="rect-image"
    model="com.axelor.apps.base.db.Product" width="25%" orderBy="code,name">
    <field name="picture"/>
    <field name="fullName"/>
    <template><![CDATA[
			<>
				<strong>{fullName}</strong>
				<Box d="grid" gridTemplateColumns="40% 60%">
					<Box style={{ width: 128, height: 64 }}>
						<Image src={$image('picture', 'content')} w={100} h={100}></Image>
					</Box>
					<Box>
						<strong>
							<span>{_t('Min stock')}</span>(<span>{$fmt('$stockMinDate')}</span>):
						</strong>
						<span>{$fmt('$stockMin')}</span>
						<Box/>
						<strong>
							<span>{_t('Max stock')}</span>(<span>{$fmt('$stockMaxDate')}</span>):
						</strong>
						<span>{$fmt('$stockMax')}</span>
					</Box>
				</Box>
			</>
		]]></template>
  </cards>

  <grid name="stock-product-grid" title="Products" model="com.axelor.apps.base.db.Product"
    orderBy="code,name">
    <field name="picture" widget="Image"/>
    <field name="code" x-bind="{{code|unaccent|uppercase}}"/>
    <field name="name" width="400"/>
    <field name="$stockMinDate" title="Min stock date" type="date"/>
    <field name="$stockMin" title="Min stock" type="integer"/>
    <field name="$stockMaxDate" title="Max stock date" type="date"/>
    <field name="$stockMax" title="Max stock" type="integer"/>
  </grid>

  <grid name="stock-move-line-product-grid" title="Products"
    model="com.axelor.apps.base.db.Product" orderBy="code,name" x-row-height="80">
    <field name="picture" widget="Image"/>
    <field name="code" x-bind="{{code|unaccent|uppercase}}" width="100"/>
    <field name="name" width="300"/>
    <field name="$availableQty" title="Available qty" type="decimal" width="120"
      sortable="false"/>
    <field name="productCategory" form-view="product-category-form"
      grid-view="product-category-grid"/>
    <field name="productFamily" form-view="product-family-form"
      grid-view="product-family-grid"/>
    <field name="productTypeSelect" width="100"/>
    <field name="salePrice" x-scale="2"/>
    <field name="unit" width="70" form-view="unit-form" grid-view="unit-grid"/>
    <field name="internalDescription" widget="html" width="400"/>
  </grid>

  <form name="stock-product-form" title="Product" model="com.axelor.apps.base.db.Product"
    width="large" onLoad="action-stock-product-method-set-stock-per-day">
    <panel name="mainPanel">
      <panel colSpan="2" name="imagePanel">
        <field name="picture" showTitle="false" colSpan="12" widget="Image"/>
        <field name="barCode" showTitle="false" colSpan="12" widget="Image"
          if="__config__.app.getApp('base')?.getActivateBarCodeGeneration()" readonly="true"
          x-height="50"/>
      </panel>
      <panel name="namePanel" colSpan="10">
        <field name="fullName" showTitle="false" css="label-bold bold large" colSpan="12">
          <editor x-show-titles="false">
            <field name="code" x-bind="{{code|unaccent|uppercase}}" showTitle="false"
              colSpan="3" css="label-bold bold large" placeholder="Code" readonly="true"/>
            <field name="name" required="true" showTitle="false" colSpan="9"
              css="label-bold bold large" placeholder="Name" readonly="true"/>
          </editor>
        </field>
      </panel>
      <panel name="stockPerDayPanel" colSpan="12">
        <field name="$stockPerDayList" title="Stock per day" type="one-to-many"
          target="com.axelor.utils.db.Wizard" grid-view="wizard-stock-perday-grid"
          form-view="wizard-stock-perday-form" readonly="true" colSpan="12"/>
      </panel>
    </panel>
  </form>

  <grid model="com.axelor.utils.db.Wizard" title="Stock per day"
    name="wizard-stock-perday-grid" orderBy="$date">
    <field name="$date" title="Date" type="date"/>
    <field name="$qty" title="Qty" type="decimal"/>
  </grid>

  <form model="com.axelor.utils.db.Wizard" title="Stock per day"
    name="wizard-stock-perday-form" canEdit="false" onNew="action-wizard-stock-per-day-attrs-scale">
    <panel name="mainPanel">
      <field name="$date" title="Date" type="date"/>
      <field name="$qty" title="Qty" type="decimal"/>
      <button name="showStockMoveLinesBtn" title="Show stock move lines"
        onClick="action-stock-product-method-display-stock-move-line"/>
    </panel>
  </form>

  <form id="stock-product-form" name="product-form" title="Product"
    model="com.axelor.apps.base.db.Product" extension="true">
    <extend target="//panel[@name='productionInformationsPanel']">
      <insert position="after">
        <panel name="trackingNumberPanel" title="Tracking number" showTitle="false"
          showIf="productTypeSelect == 'storable'" if="__config__.app.isApp('stock')">
          <panel colSpan="12" name="trackingConfigPanel">
            <field name="trackingNumberConfiguration" readonly="true"
              requiredIf="checkExpirationDateAtStockMoveRealization"
              form-view="tracking-number-configuration-form"
              grid-view="tracking-number-configuration-grid"
              if="!__config__.app.getApp('base')?.companySpecificProductFieldsSet?.find({it.name == 'trackingNumberConfiguration'})"/>
            <button name="changeTrackingNumberConfigurationButton"
              title="Change tracking number configuration"
              onClick="action-product-view-open-tracking-number-config-wizard"/>
          </panel>
        </panel>
      </insert>
    </extend>
  </form>

  <action-method name="action-stock-product-method-set-stock-per-day">
    <call class="com.axelor.apps.stock.web.ProductStockController" method="setStockPerDay"/>
  </action-method>

  <action-method name="action-stock-product-method-display-stock-move-line">
    <call class="com.axelor.apps.stock.web.ProductStockController"
      method="displayStockMoveLine"/>
  </action-method>

  <action-method name="action-product-method-update-stock-location">
    <call class="com.axelor.apps.stock.web.ProductStockController" method="updateStockLocation"/>
  </action-method>

  <action-record name="action-stock-product-record-stock-managed-onchange"
    model="com.axelor.apps.base.db.Product">
    <field name="excludeFromMrp" expr="eval: !stockManaged"/>
  </action-record>

  <action-attrs name="action-wizard-stock-per-day-attrs-scale">
    <attribute name="scale" for="$qty"
      expr="eval: __config__.app.getNbDecimalDigitForQty()"/>
  </action-attrs>

  <action-view name="action-stock-view-stock-rule" title="Stock rule"
    model="com.axelor.apps.stock.db.StockRules">
    <view type="grid" name="stock-rule-product-grid"/>
    <view type="form" name="stock-rules-form"/>
    <domain>self.product.id = :_id</domain>
    <context name="_id" expr="eval: id"/>
  </action-view>

  <action-view name="action-stock-view-stock-location-line-history"
    title="Stock location line history" model="com.axelor.apps.stock.db.StockLocationLineHistory">
    <view type="grid" name="stock-location-line-history-grid"/>
    <view type="form" name="stock-location-line-history-form"/>
    <domain>self.stockLocationLine.product.id = :_id</domain>
    <context name="_id" expr="eval: id"/>
  </action-view>


  <action-view name="action-product-view-open-tracking-number-config-wizard"
               model="com.axelor.utils.db.Wizard" title="Tracking number configuration">
    <view type="form" name="tracking-number-config-change-wizard-form"/>
    <view-param name="popup" value="true"/>
    <view-param name="show-toolbar" value="false"/>
    <view-param name="show-confirm" value="false"/>
    <view-param name="popup-save" value="false"/>
    <context name="_product" expr="eval: __self__"/>
    <context name="_oldTrackingNumberConfiguration" expr="eval: trackingNumberConfiguration"/>
  </action-view>

  <form name="tracking-number-config-change-wizard-form" title="" model="com.axelor.utils.db.Wizard"
    onNew="action-tracking-number-config-change-wizard-method-on-new">
    <panel name="mainPanel">
      <field name="$_product" title="Product" type="many-to-one"
        target="com.axelor.apps.base.db.Product"/>
      <field name="$_oldTrackingNumberConfiguration" title="Old tracking number config"
        type="many-to-one" target="com.axelor.apps.stock.db.TrackingNumberConfiguration"/>
      <field name="$_newTrackingNumberConfiguration" title="Tracking number config"
        type="many-to-one" target="com.axelor.apps.stock.db.TrackingNumberConfiguration"/>
      <field name="$_stockLocationLine" title="Stock location lines" type="one-to-many"
        target="com.axelor.apps.stock.db.StockLocationLine"
        grid-view="tracking-number-config-change-wizard-stock-location-line-grid" colSpan="12"/>
    </panel>
  </form>

  <grid name="tracking-number-config-change-wizard-stock-location-line-grid"
    title="Stock Locations content" model="com.axelor.apps.stock.db.StockLocationLine"
    orderBy="product">
    <field name="product" form-view="product-form" grid-view="product-grid"/>
    <field name="stockLocation" form-view="stock-location-form"
      grid-view="stock-location-grid"/>
    <field name="currentQty" aggregate="sum" x-scale="2"/>
    <field name="futureQty" aggregate="sum" x-scale="2"/>
    <field name="unit" form-view="unit-form" grid-view="unit-grid"/>
    <field name="$_qtyLeft" title="Quantity left" type="decimal"/>
    <button name="createDetailLinesBtn" title="Create detail lines" icon="fa-check"
      onClick="action-tracking-number-config-change-view-open-stock-location-detail-lines-creation-wizard"/>

  </grid>

  <action-method name="action-tracking-number-config-change-wizard-method-on-new">
    <call class="com.axelor.apps.stock.web.ProductStockController"
          method="trackingNumberConfigChangeOnLoad"/>
  </action-method>

  <action-view name="action-tracking-number-config-change-view-open-stock-location-detail-lines-creation-wizard"
               model="com.axelor.utils.db.Wizard" title="Stock location detail lines creation wizard">
    <view type="form" name="tracking-number-config-change-add-stock-detail-lines-wizard-form"/>
    <view-param name="popup" value="reload"/>
    <view-param name="show-toolbar" value="false"/>
    <view-param name="show-confirm" value="false"/>
    <view-param name="popup-save" value="false"/>
    <context name="_product" expr="eval: product"/>
    <context name="_stockLocation" expr="eval: stockLocation"/>
    <context name="_qtyLeft" expr="eval: _qtyLeft"/>
  </action-view>

  <form name="tracking-number-config-change-add-stock-detail-lines-wizard-form" title="Add stock detail lines wizard" model="com.axelor.utils.db.Wizard"
        onNew="action-tracking-number-config-change-record-stock-detail-lines-on-new">
    <panel name="mainPanel">
      <field name="_product" title="Product" type="many-to-one"
             target="com.axelor.apps.base.db.Product"/>
      <field name="_stockLocation" title="Stock location"
             type="many-to-one" target="com.axelor.apps.stock.db.StockLocation"/>
      <field name="_originalQtyLeft" title="Quantity left" type="decimal"/>
      <field name="$_remainingQtyLeft" title="Quantity left" type="decimal"/>
      <field name="_stockLocationLineList" title="Stock location lines" type="one-to-many"
             target="com.axelor.apps.stock.db.StockLocationLine"
             form-view="stock-location-line-details-wizard-form"
             grid-view="stock-location-line-tracking-number-config-wizard-grid" colSpan="12"
             onChange="action-tracking-number-config-record-on-stock-location-line-list-change"/>
    </panel>
  </form>

  <action-record name="action-tracking-number-config-change-record-stock-detail-lines-on-new" model="com.axelor.utils.db.Wizard">
    <field name="_product" expr="eval: _product"/>
    <field name="_stockLocation" expr="eval: _stockLocation"/>
    <field name="_originalQtyLeft" expr="eval: _qtyLeft"/>
    <field name="$_remainingQtyLeft" expr="eval: _qtyLeft"/>
  </action-record>

  <action-record name="action-tracking-number-config-record-on-stock-location-line-list-change" model="com.axelor.utils.db.Wizard">
    <field name="$_remainingQtyLeft" expr="eval: _originalQtyLeft - _stockLocationLine.sum{it.currentQty}" />
  </action-record>

  <form name="stock-location-line-details-wizard-form" title="Stock Location content" model="com.axelor.apps.stock.db.StockLocationLine"
        onLoad="action-stock-location-line-atts-avg-price-scale"
        onNew="action-stock-location-line-group-onnew, action-stock-location-line-record-fill-wizard-fields">
    <panel name="mainPanel">
      <field name="product" canEdit="false" domain="self.dtype = 'Product'" form-view="product-form" grid-view="product-grid"/>
      <field name="currentQty"/>
      <field name="futureQty"/>
      <field name="unit" form-view="unit-form" grid-view="unit-grid"/>
      <field name="avgPrice" onChange="action-stock-location-line-group-avg-price-onchange"/>
      <field if="__config__.app.getApp('supplychain')?.getManageStockReservation()" if-module="axelor-supplychain" name="reservedQty" hidden="true"/>
      <field name="trackingNumber" domain="self.product = :product"/>
      <field name="rack"/>
      <field name="detailsStockLocation"/>
      <field name="$_maxQty"/>
    </panel>
    <panel name="lastInventoryPanel" title="Last inventory">
      <field name="lastInventoryRealQty" title="Real Qty"/>
      <field name="lastInventoryDateT" title="Date"/>
    </panel>
  </form>

  <action-record name="action-stock-location-line-record-fill-wizard-fields" model="com.axelor.apps.stock.db.StockLocationLine">
    <field name="product" expr="eval: __parent__._product"/>
    <field name="detailsStockLocation" expr="eval: __parent__._stockLocation"/>
    <field name="$_maxQty" expr="eval: __parent__._remainingQtyLeft"/>
  </action-record>

</object-views>
